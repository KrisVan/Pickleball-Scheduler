# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

orbs:
  node: circleci/node@5.0.2

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/configuration-reference/#jobs
jobs:
  build_test: 
    executor: node/default
    docker :
      - image: docker pull mcr.microsoft.com/playwright:v1.39.0-jammy
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run :
        - name: Download CI dependency
        - commad: npm ci
      - run:
          name: Build app
          command: npm run build
      - run:
          name: Run tests
          command: npm run test
      - persist_to_workspace:
          root: .
          paths:
            - .
  deploy:
    executor: node/default
    steps: 
      - attach_workspace:
          at: .
      - run:
          command: ssh-keyscan github.com >> ~/.ssh/known_hosts # FIXME: /bin/bash: line 1: /home/circleci/.ssh/known_hosts: No such file or directory
          name: Add github.com to known hosts
      - run:
          command: npm run deploy
          name: Deploy app


# Orchestrate jobs using workflows
# See: https://circleci.com/docs/configuration-reference/#workflows
workflows:
  build_test_workflow:
    jobs:
      - build_test
  # build_test_deploy_workflow:
  #   jobs:
  #     - build_and_test
  #     - deploy:
  #         requires:
  #           - build_and_test # Only deploy if build and test succesful
  #         filters:
  #           branches:
  #             only: main # Only deploy when on main branch
